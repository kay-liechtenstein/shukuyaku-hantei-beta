<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>縮約ラボ | 作成</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.0/css/all.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="icon" href="fav.png" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Noto Serif JP', '游明朝', 'Yu Mincho', 'Hiragino Mincho ProN', 'MS P明朝', serif;
            background-color: #f5fcfc;
            margin: 0;
            padding: 0;
        }

        .header {
            width: 100%;
            background-color: #e8f5f5;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
        }

        .header img {
            height: 90px;
            width: auto;
            cursor: pointer;
        }

        h2 {
            text-align: center;
            font-size: 2em;
            color: #00897B;
            font-family: 'Playfair Display', serif;
            margin-top: 180px;
        }

        h2#targetRate {
            display: inline-block;
            position: relative;
            padding-bottom: 5px;
        }

        h2#targetRate::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background-color: #bfa76f;
            transition: width 0.6s ease;
        }

        h2#targetRate.underline-animate::after {
            width: 100%;
        }

        #summaryRate {
            position: relative;
            display: inline-block;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .container {
            width: 90%;
            max-width: 1100px;
            margin: 30px auto 50px auto;
            display: flex;
            gap: 20px;
            justify-content: center;
            padding: 0 20px;
        }

        .column {
            flex: 1;
            background: #fff;
            border: 2px solid #bfa76f;
            padding: 20px;
            min-height: 200px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.03);
        }

        .highlight { background-color: cyan; }
        .output-wrapper { display: flex; justify-content: space-between; align-items: center; }
        .output-title { font-size: 1.2em; font-weight: bold; color: #00897B; margin-top: 0; }

        .downloadButton {
            background-color: #28a745;
            border: none;
            border-radius: 6px;
            padding: 10px 12px;
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }

        .downloadButton:hover {
            background-color: #218838;
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }

        .downloadButton .material-icons {
            font-size: 24px;
            color: white;
        }

        .copyButton {
            background-color: #17a2b8;
            border: none;
            border-radius: 6px;
            padding: 10px 12px;
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
        }

        .copyButton:hover {
            background-color: #138496;
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }

        .copyButton .material-icons {
            font-size: 24px;
            color: white;
        }

        .highlightButton {
            background-color: #17a2b8;
            border: none;
            border-radius: 6px;
            padding: 10px 12px;
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
            align-items: center;
        }

        .highlightButton.active {
            background-color: #a89454;
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }

        @media (min-width: 769px) {
            .highlightButton:hover {
                background-color: #a89454;
                box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
            }
        }

        .highlightButton .material-icons {
            font-size: 24px;
            color: white;
        }

        #leftColumn.highlight-mode {
            cursor: crosshair;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #leftColumn, #highlightedText {
            white-space: pre-wrap;
            font-size: 1em;
            padding: 10px;
        }

        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .highlightButton { display: flex; }
        }

        @keyframes sparkle {
            0% {
                opacity: 0;
                transform: scale(0.8) rotate(0deg);
            }
            50% {
                opacity: 1;
                transform: scale(1.3) rotate(180deg);
            }
            100% {
                opacity: 0;
                transform: scale(0.8) rotate(360deg);
            }
        }

        #summaryRate.sparkle::after {
            content: "✨";
            position: absolute;
            top: -15px;
            right: -25px;
            font-size: 1.4em;
            animation: sparkle 1.3s ease-out forwards;
            pointer-events: none;
        }

        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip-text {
            visibility: hidden;
            background-color: #333;
            color: #fff;
            font-size: 0.8em;
            text-align: center;
            border-radius: 4px;
            padding: 5px 8px;
            position: absolute;
            z-index: 200;
            bottom: 130%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s;
            white-space: nowrap;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="index.html">
            <img src="logo.png" alt="Logo">
        </a>
    </div>
    <div style="text-align: center;">
        <h2 id="targetRate"></h2>
    </div>
    <div style="text-align: center;">
        <div id="summaryRate">現在の縮約率: 0.00%</div>
    </div>
    <div class="container">
        <div class="column">
            <div class="output-wrapper">
                <h2 class="output-title">縮約に使う文字をハイライト</h2>
                <div class="tooltip-container highlight-button-container">
                    <button class="highlightButton">
                        <span class="material-icons">edit</span>
                    </button>
                    <div class="tooltip-text">テキストをハイライト</div>
                </div>
            </div>
            <div id="leftColumn" contenteditable="false">
                </div>
        </div>
        <div class="column">
            <div class="output-wrapper">
                <h2 class="output-title">縮約後のテキスト</h2>
                <div class="tooltip-container">
                    <button class="copyButton" onclick="copyToClipboard()">
                        <span class="material-icons">content_copy</span>
                    </button>
                    <div class="tooltip-text">クリップボードにコピー</div>
                </div>
            </div>
            <div id="highlightedText"></div>
        </div>
    </div>

    <script>
        // Add underline animation on page load
        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const targetRateElement = document.getElementById('targetRate');
                if (targetRateElement) {
                    targetRateElement.classList.add('underline-animate');
                }
            }, 300);
        });

        const urlParams = new URLSearchParams(window.location.search);
        const inputText = sessionStorage.getItem('inputText');
        const targetRateValue = sessionStorage.getItem('targetRate');

        const originalText = inputText || '';
        const originalTextLength = originalText.replace(/\s+/g, '').length;

        const leftColumn = document.getElementById('leftColumn');
        const targetRateDisplay = document.getElementById('targetRate');
        const highlightedTextDisplay = document.getElementById('highlightedText');
        const summaryRateDisplay = document.getElementById('summaryRate');
        const highlightButton = document.querySelector('.highlightButton');
        
        let isHighlightMode = false;
        let isTouchHighlighting = false;
        let touchedChars = new Set();

        // ハイライトの範囲を {start, end} オブジェクトの配列として格納
        let highlightRanges = [];

        if (targetRateValue) {
            targetRateDisplay.textContent = `目標縮約率: ${targetRateValue}%`;
        }

        // ハイライトボタンのクリックイベント
        highlightButton.addEventListener('click', () => {
            isHighlightMode = !isHighlightMode;
            highlightButton.classList.toggle('active');
            leftColumn.classList.toggle('highlight-mode');
            
            if (isHighlightMode) {
                // タッチモードを有効化
                leftColumn.setAttribute('contenteditable', 'false');
            } else {
                // タッチモードを無効化
                leftColumn.setAttribute('contenteditable', 'false');
                touchedChars.clear();
            }
        });

        // タッチイベントの処理
        function getCharIndexFromPoint(x, y) {
            const range = document.caretRangeFromPoint(x, y);
            if (!range) return -1;
            
            const preRange = range.cloneRange();
            preRange.selectNodeContents(leftColumn);
            preRange.setEnd(range.startContainer, range.startOffset);
            return preRange.toString().length;
        }

        leftColumn.addEventListener('touchstart', (e) => {
            if (!isHighlightMode) return;
            e.preventDefault();
            isTouchHighlighting = true;
            touchedChars.clear();
            
            const touch = e.touches[0];
            const charIndex = getCharIndexFromPoint(touch.clientX, touch.clientY);
            if (charIndex !== -1) {
                touchedChars.add(charIndex);
            }
        });

        leftColumn.addEventListener('touchmove', (e) => {
            if (!isHighlightMode || !isTouchHighlighting) return;
            e.preventDefault();
            
            const touch = e.touches[0];
            const charIndex = getCharIndexFromPoint(touch.clientX, touch.clientY);
            if (charIndex !== -1) {
                touchedChars.add(charIndex);
            }
        });

        leftColumn.addEventListener('touchend', (e) => {
            if (!isHighlightMode || !isTouchHighlighting) return;
            e.preventDefault();
            isTouchHighlighting = false;
            
            if (touchedChars.size > 0) {
                // タッチされた文字の範囲を計算
                const sortedIndices = Array.from(touchedChars).sort((a, b) => a - b);
                let ranges = [];
                let rangeStart = sortedIndices[0];
                let rangeEnd = sortedIndices[0];
                
                for (let i = 1; i < sortedIndices.length; i++) {
                    if (sortedIndices[i] - sortedIndices[i-1] <= 1) {
                        rangeEnd = sortedIndices[i];
                    } else {
                        ranges.push({start: rangeStart, end: rangeEnd + 1});
                        rangeStart = sortedIndices[i];
                        rangeEnd = sortedIndices[i];
                    }
                }
                ranges.push({start: rangeStart, end: rangeEnd + 1});
                
                // 各範囲をハイライト
                ranges.forEach(range => {
                    highlightSelection(range.start, range.end);
                });
                
                renderTextWithHighlights();
                updateHighlightedText();
                updateSummaryRate();
                touchedChars.clear();
            }
        });

        // DOMの選択範囲を文字インデックスに変換する関数
        function getSelectionCharacterOffsetWithin(element) {
            let start = 0;
            let end = 0;
            const selection = window.getSelection();

            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const preSelectionRange = range.cloneRange();
                preSelectionRange.selectNodeContents(element);
                preSelectionRange.setEnd(range.startContainer, range.startOffset);
                start = preSelectionRange.toString().length;
                end = start + range.toString().length;
            }
            return { start, end };
        }

        // 選択に基づいてハイライトまたはハイライト解除を適用する関数
        leftColumn.addEventListener('mouseup', () => {
            // ハイライトモードの場合はマウスイベントを無視
            if (isHighlightMode) return;
            const selection = window.getSelection();
            if (!selection.rangeCount || !selection.toString().trim()) {
                return;
            }

            const { start, end } = getSelectionCharacterOffsetWithin(leftColumn);
            if (start === end) { // 実際にテキストが選択されていない場合
                return;
            }

            // 選択された範囲が既存のハイライト内に完全に含まれているかチェック
            let isUnhighlight = false;
            for (let i = 0; i < highlightRanges.length; i++) {
                const hr = highlightRanges[i];
                if (start >= hr.start && end <= hr.end) {
                    isUnhighlight = true;
                    break;
                }
            }

            if (isUnhighlight) {
                unhighlightSelection(start, end);
            } else {
                highlightSelection(start, end);
            }

            renderTextWithHighlights();
            updateHighlightedText();
            updateSummaryRate();
            selection.removeAllRanges(); // 処理後に選択をクリア
        });

        function highlightSelection(newStart, newEnd) {
            // 新しい範囲を追加し、すべての範囲を結合/ソートする
            highlightRanges.push({ start: newStart, end: newEnd });
            mergeAndSortHighlights();
        }

        function unhighlightSelection(unStart, unEnd) {
            let newHighlightRanges = [];
            highlightRanges.forEach(hr => {
                // ケース1: ハイライトされた範囲がハイライト解除範囲の完全に外側にある
                if (hr.end <= unStart || hr.start >= unEnd) {
                    newHighlightRanges.push(hr);
                }
                // ケース2: ハイライトされた範囲がハイライト解除範囲を完全に覆っている
                else if (hr.start < unStart && hr.end > unEnd) {
                    newHighlightRanges.push({ start: hr.start, end: unStart });
                    newHighlightRanges.push({ start: unEnd, end: hr.end });
                }
                // ケース3: ハイライト解除範囲がハイライト内で始まり、外側に広がる
                else if (hr.start < unStart && hr.end <= unEnd) {
                    newHighlightRanges.push({ start: hr.start, end: unStart });
                }
                // ケース4: ハイライト解除範囲がハイライト内で終わり、以前に始まる
                else if (hr.start >= unStart && hr.end > unEnd) {
                    newHighlightRanges.push({ start: unEnd, end: hr.end });
                }
                // ケース5: ハイライトされた範囲がハイライト解除範囲内に完全に含まれている（削除する）
                // このケースは、'hr'をnewHighlightRangesにプッシュしないことで暗黙的に処理される
            });
            highlightRanges = newHighlightRanges;
            mergeAndSortHighlights(); // ハイライト解除後に再度結合
        }

        function mergeAndSortHighlights() {
            if (highlightRanges.length === 0) {
                return;
            }

            // 開始インデックスでソート
            highlightRanges.sort((a, b) => a.start - b.start);

            const merged = [];
            let current = highlightRanges[0];

            for (let i = 1; i < highlightRanges.length; i++) {
                const next = highlightRanges[i];
                // 現在の範囲が次の範囲と重複または隣接している場合、結合する
                if (current.end >= next.start) {
                    current.end = Math.max(current.end, next.end);
                } else {
                    merged.push(current);
                    current = next;
                }
            }
            merged.push(current); // 最後に結合された範囲を追加
            highlightRanges = merged;
        }

        function renderTextWithHighlights() {
            leftColumn.innerHTML = ''; // 既存のコンテンツをクリア
            let currentIndex = 0;

            if (!originalText) {
                leftColumn.innerHTML = '<p>テキストがありません。</p>';
                return;
            }

            highlightRanges.forEach(hr => {
                // ハイライトの前にプレーンテキストを追加 (存在する場合)
                if (hr.start > currentIndex) {
                    leftColumn.appendChild(document.createTextNode(originalText.substring(currentIndex, hr.start)));
                }

                // ハイライトされたテキストを追加
                const span = document.createElement('span');
                span.className = 'highlight';
                span.textContent = originalText.substring(hr.start, hr.end);
                leftColumn.appendChild(span);

                currentIndex = hr.end;
            });

            // 最後のハイライトの後に残っているプレーンテキストを追加
            if (currentIndex < originalText.length) {
                leftColumn.appendChild(document.createTextNode(originalText.substring(currentIndex)));
            }
        }

        function updateHighlightedText() {
            let selectedChars = '';
            highlightRanges.forEach(hr => {
                selectedChars += originalText.substring(hr.start, hr.end);
            });
            highlightedTextDisplay.textContent = selectedChars;
        }

        let prevColorPink = false;

        function updateSummaryRate() {
            let highlightedLength = 0;
            highlightRanges.forEach(hr => {
                highlightedLength += originalText.substring(hr.start, hr.end).replace(/\s+/g, '').length;
            });

            const summaryPercentage = originalTextLength > 0
                ? ((highlightedLength / originalTextLength) * 100).toFixed(2)
                : 0;

            summaryRateDisplay.textContent = `現在の縮約率: ${summaryPercentage}%`;

            if (targetRateValue) {
                const targetRateNum = parseFloat(targetRateValue);
                const lowerBound = targetRateNum - 5;
                const upperBound = targetRateNum + 5;
                const isNowPink = (summaryPercentage >= lowerBound && summaryPercentage <= upperBound);

                if (isNowPink && !prevColorPink) {
                    summaryRateDisplay.classList.add('sparkle');
                    setTimeout(() => summaryRateDisplay.classList.remove('sparkle'), 900);
                }

                summaryRateDisplay.style.color = isNowPink ? 'deeppink' : '#333';
                prevColorPink = isNowPink;
            }
        }

        function copyToClipboard() {
            const text = document.getElementById('highlightedText').textContent;
            navigator.clipboard.writeText(text)
                .then(() => {
                    Swal.fire({
                        text: 'クリップボードにコピーしました。',
                        icon: 'success',
                        confirmButtonText: 'OK'
                    });
                })
                .catch(() => {
                    Swal.fire({
                        text: 'コピーに失敗しました。',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                });
        }

        // 初期表示と更新
        renderTextWithHighlights();
        updateHighlightedText();
        updateSummaryRate();
    </script>
</body>
</html>